# Импорт открытых данных ЕМИСС в PostgreSQL. Полнотекстовый поиск. Разработка api и ui.
## 1. Введение.
Доступ к открытым источникам информации становится все более важным для разработчиков и исследователей. Одним из таких источников является Единый межведомственный информационный справочник (ЕМИСС), который предоставляет богатый набор данных для анализа и разработки приложений. В данной статье я поделюсь своим опытом работы с данными из ЕМИСС, начиная с их извлечения и импорта в базу данных PostgreSQL, и заканчивая созданием веб-приложения с использованием API для эффективного поиска и визуализации информации.

Процесс включает в себя несколько этапов: от выгрузки данных и их преобразования до разработки веб-интерфейса. Ниже расскажу о выбранных инструментах и технологиях, с которыми я столкнулся на каждом этапе, а также о возникающих трудностях и решениях, которые я применял. В данном проекте преследовал цели получения опыта разработчика, dba, devops, а также более глубокий опыт работы с данными и поиск новых подходов и идей.

## 2. «Клон» ЕМИСС.
На просторах интернета мне попалась статья о том как создать свою портативную СУБД с базой Росстата https://habr.com/ru/articles/532244/. После её изучения я приступил к установке необходимого софта.
### 2.1. Уcтановка PostgreSQL.
Для промышленного решения можно было реализовать кластер Postgres (например через Patroni) либо запустить в docker, но, т.к. проект планировался только для домашнего пользования, Postgres разворачивался локально на моей машине MacBook Pro с чипом Apple M2 Pro и ядром Darwin Kernel Version 23.6.0. 
Поэтому на момент установки 06.11.2024 мне досталась версия:
```
PostgreSQL 16.4 (Homebrew) on aarch64-apple-darwin23.6.0, compiled by Apple clang version 16.0.0 (clang-1600.0.26.4), 64-bit
```
Далее потребуется несколько настроек:
+ Инициализация Базы (Создание экземпляра)
+ Конфигурация pg_hba.conf (Для доступа к экзмепляру не только для localhost)
+ Конфигурация postgresql.conf (Для оптимальной работы, учитывая специфику проекта, я воспользовался калькулятором https://www.pgconfig.org/)
+ Созданиие роли (Для доступа к psql)
+ Установка менеджера СУБД (Для создания базы и скриптов)

На этих этапах не обошлось без сложностей, в основном они были связаны с безопасностью mac, его переменными окружения, особенностями установки.
### 2.2. Импорт данных.
Перед импортом данных клонировал репозиторий https://github.com/S0mbre/russtat.
Затем установил python и несколько его библиотек (снова потратил время на решение проблем с зависимостями и переменными окружения).
Далее изучив статью, код для импорта данных и немного структуру xml (предоставляемые ЕМИСС) приступил к созданию бд (скрипт находился в том же репозитории). Стоит обратить внимание, что скрипты могут быть не адаптированы под ваше окружение postgres, поэтому выполнять их лучше по частям (у меня были ошибки с локалью).

После того как бд с необходимыми таблицами создалась, я начал "заливать" данные (предварительно настроив подключение к бд в py-скриптах), заняло это около 2 часов.
### 2.3. Расширение функционала.
Струтура бд вышла как и ожидалась: https://habrastorage.org/webt/ua/7y/ri/ua7yri777bmmai52usta6_sbgz0.png
Немного пошаманив с удалением дублей и лишних строк, мне удалось ознакомиться с джойнами таблиц и обнаружить несколько проблем.
Поэтому, в  дополнение к основному коду, в репозитрии есть каталог sql
#### 2.3.1 Даты.
В таблице periods, значения, которые в будущем использовались бы для построения графиков и т.д., имели следующий вид:
```
Квартальная - текущий период
Годовая - среднегодовая
Месячная - за период, нарастающим итогом с начала года
за I полугодие - не охарактеризована
1 раз в 4-5 лет - не охарактеризована
11 августа
на 31 декабря
Квартальная - текущий период
```
При этом значения года (2000, 2010 и т.д.) хранились в нужном значении, а именно в поле obs_year таблицы obs.
Учитывая весь этот беспредел, пришлось разработать пару функций для преобразования даты в нужном формате DD.MM.YYYY
format_date - конвертирует число/месяц в DD.MM.
convert_to_date - преобразует дату в DD.MM.YYYY
#### 2.3.2 Полнотекстовый поиск.
В описанной статье, у автора уже были наработки по полнотекстовому поиску, однако реализация меня не устроила по причинам скорости работы поиска (получали излишне много данных) и отличия от архитектуры решения.
Поэтому была разработана функция поиска по полнотексту get_datasets_by_search где на вход подается строка (вводимая на сайте) и результат возвращает список таблиц, индетификаторов строк и rank где встречается эта строка с учетом словоформ и т.д.
## 3. API.
Чтобы подружить Frontend в базой, я использовал node.js. 
Структура файлов получилась следующей:
node
├── Dockerfile
├── controllers
│   └── searchController.js
├── docker-compose.yml
├── models
│   └── db.js
├── node_modules...  
├── package-lock.json
├── package.json
├── routes
│   └── api.js
└── server.js
+ server.js - Перечень модулей, порта, маршрутов
+ api.js - Определения маршрутов
+ package.json - Версии модулей
+ node_modules - Сами модули
+ docker-compose.yml - Докер-композ для запуска апи-сервера emiss-api (поддержка переменных для подключения к postgres)
+ searchController.js - Код api-методов
+ Dockerfile - Файл для создания docker-образа emiss-api
## 3. WEB.
Для Frontend используется html, css, js.
Все элементы в основном генерируются через js, после обработки api-запросов.
Для создания графиков используется библиотека Сhart.js, а также xlsx.full.min.js для выгрузки данных в excel.
Структура файлов:
web
├── Dockerfile
├── css
│   ├── dark-theme.css
│   └── light-theme.css
├── docker-compose.yml
├── img
│   ├── dark_diag_001.svg
│   ├── ...
├── index.html
├── js
│   ├── change_theme.js
│   ├── search.js
│   └── switch_tabs.js
└── nginx.conf
+ nginx.conf - Конфиг nginx, т.к. сайт будет работать именно на нем
+ js - Каталог с основным кодом, все обращения к базе, а также генерация блоков, таблиц, графиков и мобальных окон на сайте описаны в search.js (В будущем будет разделен на логические структуры).
+ img - Картинки на сайте (логотип, фавикон, картинки схем данных)
+ docker-compose.yml - Докер-композ для запуска веб-сервера emiss-web
+ css - стили (поддерживается темная и светлая тема)
+ Dockerfile - Файл для создания docker-образа emiss-web
## 4. Публикация сайта.
Для оптимизации затрат на аренду сервера и DNS, я решил использовать штатные средства маршрутизатора Keenetic для организации доступа к своему проекту. Настроил перенаправление портов для API-сервера, который работает на порту 3000, и перенаправление для веб-сервера, использующего порт 443 для безопасного соединения. Также настроил динамическое DNS, что позволяет мне легко получать доступ серверу, даже если IP-адрес меняется.
Таким образом значительно сократил расходы и обеспечил гибкость в управлении.
## 5. DevOps.
Для автоматизации сборки и развертывания приложения (api и web) решил использовать Jenkins (развернутый локально в докере на моей машине) и вебхуки GitHub.
То есть после получении нового коммита GitHub отправляет уведомление (вебхук) на URL Jenkins и запускается пайплайн, включающий в себя клонирование репозитория, остановку работающих контейнеров, удаление действующих образов, сборку новых docker-образов, запуск обновленных контейнеров через docker-compose.
На текущий момент пайплайн дописывается.
...
...

## 6. Скриншоты
Модальное окно схемы данны:
![001](https://raw.githubusercontent.com/yarkozloff/emiss/refs/heads/main/screenshots/001.png)

Список рубрик от ведомств:
![002](https://raw.githubusercontent.com/yarkozloff/emiss/refs/heads/main/screenshots/002.png)

Поиски по тематикам (от 3 символов) и полнотекстовый поиск:
![003](https://raw.githubusercontent.com/yarkozloff/emiss/refs/heads/main/screenshots/003.png)

Смена темы и новый полнотекстовый поиск:
![004](https://raw.githubusercontent.com/yarkozloff/emiss/refs/heads/main/screenshots/004.png)

Модальное окно с показателем - Таблица (Светлая тема):
![005](https://raw.githubusercontent.com/yarkozloff/emiss/refs/heads/main/screenshots/005.png)

Модальное окно с показателем - График Line (Темная тема):
![006](https://raw.githubusercontent.com/yarkozloff/emiss/refs/heads/main/screenshots/006.png)

Модальное окно с показателем - График Bar (Темная тема):
![007](https://raw.githubusercontent.com/yarkozloff/emiss/refs/heads/main/screenshots/007.png)

Модальное окно с показателем - График Radar (Светлая тема):
![008](https://raw.githubusercontent.com/yarkozloff/emiss/refs/heads/main/screenshots/008.png)